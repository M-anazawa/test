◾️Redshiftとは

[参考文献]
https://docs.aws.amazon.com/redshift/latest/mgmt/welcome.html


◾️手順概要
Amazon Redshift クラスターを別の AWS アカウントに安全に移行するには、以下の手順を実施します。
1. 手動スナップショットの作成: ソースアカウントで移行対象の Redshift クラスターの手動スナップショットを作成します。 
2. スナップショットの共有: 作成したスナップショットをターゲットアカウントと共有します。 
3. クラスターの復元: ターゲットアカウントで共有されたスナップショットから新しいクラスターを復元します。 

この方法により、データの整合性を保ちながら、Redshift クラスターを別の AWS アカウントに移行できます。
また、データ共有機能を使用して、リアルタイムでデータを複数のアカウント間で共有することも可能です。

これらの手順を実施する際は、適切なアクセス許可とセキュリティ設定を確認し、データの保護を確実に行ってください。

[参考文献]
https://repost.aws/ja/knowledge-center/account-transfer-redshift?utm_source=chatgpt.com

[移行要件]
* 新しいクラスターには、別のドメインネームシステム (DNS) エンドポイントが設定されます。つまり、新しいエンドポイントを参照するよう、すべてのクライアント、アプリケーションコード、Amazon Kinesis Data Firehose 配信ストリームを更新する必要があります。
* Amazon Simple Storage Service (Amazon S3) ログ設定は移行されません。新しいクラスターでデータベース監査ログ記録をアクティブ化する必要があります。
* STL テーブルと SVL テーブルに保存されている履歴情報は、新しいクラスターで保持されません。

1. 手動スナップショットの作成

Amazon Redshift は、暗号化された Secure Sockets Layer (SSL) 接続を使用して、これらのスナップショットを Amazon S3 に内部的に保存します。

クラスターを起動するときに、自動スナップショットと手動スナップショットの保持期間を設定できます。
自動スナップショットと手動スナップショットのデフォルトの保持期間は、クラスターを変更することで変更できます。
手動スナップショットの保持期間は、スナップショットを作成するとき、またはスナップショットを変更することで変更できます。

スナップショットから復元すると、Amazon Redshift は新しいクラスターを作成し、すべてのデータがロードされる前に新しいクラスターを使用可能にします。そのため、新しいクラスターのクエリをすぐに開始できます。クラスターは、アクティブなクエリに応じてスナップショットからオンデマンドでデータをストリーミングし、残りのデータをバックグラウンドでロードします。

AWS マネジメントコンソールでスナップショットの詳細を表示するか、CLI またはDescribeClusterSnapshots API アクションでdescribe-cluster-snapshots を呼び出すことによって、スナップショットの進行状況を監視できます。
進行中のスナップショットの場合、増分スナップショットのサイズ、転送速度、経過時間、残り時間の見積もりなどの情報が表示されます。

バックアップが常にクラスターで利用できるようにするために、Amazon Redshift は、Amazon Redshift によって管理される内部管理の Amazon S3 バケットにスナップショットを保存します。

手動スナップショットはいつでも作成できます。デフォルトでは、手動スナップショットはクラスターを削除した後でも無期限に保持されます。手動スナップショットを作成するときに保持期間を指定するか、スナップショットを変更して保持期間を変更できます。保持期間の変更の詳細については、「手動スナップショットの保持期間の変更」を参照してください。
Amazon Redshift には、作成できる手動スナップショットの合計数を制限するクォータがあります。このクォータは、AWS リージョンごとの AWS アカウントごとです。デフォルトのクォータは、 Amazon Redshift のクォータと制限に記載されています。

[手順]
https://docs.aws.amazon.com/redshift/latest/mgmt/snapshot-create.html

[参考文献]
https://docs.aws.amazon.com/redshift/latest/mgmt/working-with-snapshots.html

2. スナップショットの共有

既存の手動スナップショットを他の AWS 顧客アカウントと共有するには、スナップショットへのアクセスを許可します。各スナップショットには最大 20 個、各 AWS Key Management Service (AWS KMS) キーには最大 100 個を許可できます。つまり、1 つの KMS キーで暗号化されたスナップショットが 10 個ある場合、各スナップショットを復元するために 10 個の AWS アカウントを許可できます。または、合計で 100 個のアカウントになり、各スナップショットのアカウント数が 20 を超えないその他の組み合わせを許可できます。許可されたアカウントのいずれかにユーザーとしてログインしたユーザーは、スナップショットを記述したり、スナップショットを復元して、自分のアカウントで新しい Amazon Redshift クラスターを作成したりできます。たとえば、本番環境とテスト環境に別の AWS 顧客アカウントを使用している場合、ユーザーは本番環境アカウントを使用してログオンし、テストアカウントのユーザーとスナップショットを共有できます。テストアカウントユーザーとしてログオンしたユーザーは、スナップショットを復元して、テストまたは診断作業用にテストアカウントが所有する新しいクラスターを作成できます。

手動スナップショットは、それが作成された AWS カスタマーアカウントによって永続的に所有されます。スナップショットを所有するアカウントのユーザーのみが、他のアカウントにスナップショットへのアクセスを許可したり、承認を取り消したりできます。承認されたアカウントのユーザーは、共有されたスナップショットの説明または復元のみを実行できます。共有されたスナップショットをコピーまたは削除することはできません。承認は、スナップショットの所有者が取り消すまで有効です。承認が取り消されると、以前に承認されたユーザーはスナップショットを表示できなくなり、スナップショットを参照する新しいアクションを開始できなくなります。アクセスが取り消されたときにアカウントがスナップショットの復元中である場合、復元は完了するまで実行されます。スナップショットにアクティブな承認がある間は、スナップショットを削除できません。最初にすべての承認を取り消す必要があります。

暗号化されたスナップショットを共有する際のセキュリティ上の考慮事項
https://docs.aws.amazon.com/redshift/latest/mgmt/working-with-snapshot-share-snapshot.html#snapshot-share-access-kms-key

[コンソールを使用してクラスタースナップショットを共有する手順]
https://docs.aws.amazon.com/redshift/latest/mgmt/working-with-snapshot-share-snapshot.html#snapshot-share

[参考文献]
https://docs.aws.amazon.com/redshift/latest/mgmt/working-with-snapshot-share-snapshot.html


3. クラスターの復元

スナップショットには、クラスターで実行されているすべてのデータベースのデータが含まれます。また、ノードの数、ノードの種類、管理者ユーザー名など、クラスターに関する情報も含まれます。スナップショットからクラスターを復元する場合、Amazon Redshift はクラスター情報を使用して新しいクラスターを作成します。次に、スナップショット データからすべてのデータベースを復元します。
元のスナップショットから作成された新しいクラスターでは、ノードタイプやノード数などの設定を選択できます。リクエストで別のアベイラビリティーゾーンを指定しない限り、クラスターは同じ AWS リージョンと、ランダムにシステムが選択したアベイラビリティーゾーンに復元されます。スナップショットからクラスターを復元する場合、オプションで新しいクラスターと互換性のあるメンテナンストラックを選択できます。

[参考文献]
https://docs.aws.amazon.com/redshift/latest/mgmt/working-with-snapshot-restore-cluster-from-snapshot.html

◾️AWS アカウント間のデータの共有

[参考文献]
https://docs.aws.amazon.com/ja_jp/redshift/latest/dg/across-account.html?utm_source=chatgpt.com

◾️AWS CLI

以下に、AWS CLI を使用して要求された操作を行うための代表的なコマンド例を示します。
コマンド実行時には、必要に応じて --region オプションや --profile オプションを付与し、
適宜パラメータ(クラスター名、スナップショット名、共有先のAWSアカウントIDなど)を変更してください。

1. 手動スナップショット取得
aws redshift create-cluster-snapshot \
    --cluster-identifier my-cluster \
    --snapshot-identifier my-manual-snapshot

2. スナップショット進捗確認（転送速度、経過時間、残り時間など）
手動スナップショット作成が完了するまでの進行状況は describe-cluster-snapshots コマンドで確認できます。出力には Status や CurrentBackupRateInMegaBytesPerSecond, EstimatedSecondsToCompletion などが含まれます。

aws redshift describe-cluster-snapshots \
    --snapshot-identifier my-manual-snapshot

レスポンス例（抜粋）:
{
    "Snapshots": [
        {
            "SnapshotIdentifier": "my-manual-snapshot",
            "Status": "creating",
            "CurrentBackupRateInMegaBytesPerSecond": 5.0,
            "EstimatedSecondsToCompletion": 300,
            "ElapsedTimeInSeconds": 60
        }
    ]
}

3. 手動スナップショットリスト確認
手動スナップショットだけを一覧表示するには、--snapshot-type manual を指定します。

aws redshift describe-cluster-snapshots --snapshot-type manual

4. 手動スナップショット削除

aws redshift delete-cluster-snapshot \
    --snapshot-identifier my-manual-snapshot

5. スナップショットの共有
指定した手動スナップショットを別のAWSアカウント(例: 123456789012)と共有するには modify-cluster-snapshot を使用します。

aws redshift modify-cluster-snapshot \
    --snapshot-identifier my-manual-snapshot \
    --accounts-with-restore-access 123456789012

共有を解除する場合:
aws redshift modify-cluster-snapshot \
    --snapshot-identifier my-manual-snapshot \
    --no-accounts-with-restore-access

6. スナップショットからのクラスター復元
既存のスナップショットからクラスターを復元します。

aws redshift restore-from-cluster-snapshot \
    --cluster-identifier my-restored-cluster \
    --snapshot-identifier my-manual-snapshot

7. クラスター復元進捗確認（スナップショットデータのサイズ、転送速度、経過時間、残り時間）
クラスター復元の進行状況は describe-cluster-restore-status コマンドで確認可能です。

aws redshift describe-cluster-restore-status \
    --cluster-identifier my-restored-cluster

このコマンドのレスポンスには、ProgressInMegaBytes, TotalDataInMegaBytes, ElapsedTimeInSeconds, EstimatedTimeToCompletionInSeconds などが含まれます。これにより、データ転送速度や残り時間を把握できます。

以上のコマンドを用いることで、手動スナップショットの取得・確認・削除、共有、そしてスナップショットからのクラスター復元や進捗確認が可能となります。
