name: Manage Rollback Branches

on:
  pull_request:
    types:
      - closed

jobs:
  manage-rollback:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.merged }}
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Setup environment
        run: |
          echo "MERGE_TIME=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV
          echo "BASE_BRANCH=${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
          echo "ROLLBACK_BRANCH=${{ github.event.pull_request.base.ref }}Rollback${{ env.MERGE_TIME }}" >> $GITHUB_ENV
          echo "MERGE_TIME: ${{ env.MERGE_TIME }}"
          echo "BASE_BRANCH: ${{ env.BASE_BRANCH }}"
          echo "ROLLBACK_BRANCH: ${{ env.ROLLBACK_BRANCH }}"

      - name: Fetch and create rollback branch
        run: |
          git fetch origin
          git checkout -b $ROLLBACK_BRANCH origin/${{ env.BASE_BRANCH }}
          git log -1
          echo "Created rollback branch $ROLLBACK_BRANCH"

      - name: Create and push rollback branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git fetch origin ${{ env.BASE_BRANCH }}
          git reset --hard origin/${{ env.BASE_BRANCH }}
          git push --force origin $ROLLBACK_BRANCH
          echo "Pushed rollback branch $ROLLBACK_BRANCH"
          git branch -r

      - name: Prune old rollback branches
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ROLLBACK_PREFIX="${{ env.BASE_BRANCH }}Rollback"
          git fetch --prune origin
          ROLLBACK_BRANCHES=$(git for-each-ref --format='%(refname:short)' refs/remotes/origin | grep ${ROLLBACK_PREFIX} | sort -r)
          COUNTER=0
          for BRANCH in $ROLLBACK_BRANCHES; do
            if [[ $COUNTER -ge 5 ]]; then
              git push origin --delete "${BRANCH#origin/}"
            fi
            COUNTER=$((COUNTER+1))
          done
          echo "Pruned old rollback branches"
