import { v4 as uuidv4 } from 'uuid';

const rdsSnapshotProject = new codebuild.Project(this, `${context.codeBuildProjectWebappName}-rds-snapshot`, {
  projectName: `${context.codeBuildProjectWebappName}-rds-snapshot`,
  environment: {
    buildImage: codebuild.LinuxBuildImage.STANDARD_5_0,
    computeType: codebuild.ComputeType.SMALL,
  },
  environmentVariables: {
    RDS_INSTANCE_IDENTIFIER: {
      value: context.rdsInstanceId,
    },
    UUID: {
      value: uuidv4(),
    },
    TIMESTAMP: {
      value: String(Date.now()),
    },
    SNAPSHOT_IDENTIFIER: {
      value: `snapshot-${context.rdsInstanceId.replace(/[^a-zA-Z0-9-]/g, '')}-${uuidv4()}-${Date.now()}`
    },
  },
  buildSpec: codebuild.BuildSpec.fromObject({
    version: "0.2",
    phases: {
      install: {
        commands: [
          "echo Installing dependencies..."
        ],
      },
      pre_build: {
        commands: [
          "echo Pre-build phase...",
          "UUID=$(uuidgen)",
          "TIMESTAMP=$(date +%s)",
          "export SNAPSHOT_IDENTIFIER=\"snapshot-${RDS_INSTANCE_IDENTIFIER}-${UUID}-${TIMESTAMP}\"",
          "echo Using snapshot identifier: $SNAPSHOT_IDENTIFIER"
        ],
      },
      build: {
        commands: [
          "echo Creating RDS snapshot...",
          "aws rds create-db-snapshot --db-instance-identifier $RDS_INSTANCE_IDENTIFIER --db-snapshot-identifier $SNAPSHOT_IDENTIFIER"
        ],
      },
    },
  }),
});
