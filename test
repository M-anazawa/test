import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as kms from 'aws-cdk-lib/aws-kms';
import * as s3 from 'aws-cdk-lib/aws-s3';
import * as iam from 'aws-cdk-lib/aws-iam';

export class InspectorExportStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // 1. KMS キーの作成
    const inspectorExportKey = new kms.Key(this, 'InspectorExportKey', {
      description: 'KMS key for encrypting Amazon Inspector export reports',
      enableKeyRotation: true,
      // ※本番環境では削除ポリシー等の設定は検討してください
      removalPolicy: cdk.RemovalPolicy.RETAIN,
    });

    // KMS キーポリシーを追加
    inspectorExportKey.addToResourcePolicy(new iam.PolicyStatement({
      sid: "Allow Amazon Inspector to use the key",
      effect: iam.Effect.ALLOW,
      principals: [new iam.ServicePrincipal('inspector2.amazonaws.com')],
      actions: [
        "kms:Decrypt",
        "kms:GenerateDataKey*"
      ],
      resources: ["*"],
      conditions: {
        "StringEquals": {
          "aws:SourceAccount": "111122223333"
        },
        "ArnLike": {
          "aws:SourceArn": "arn:aws:inspector2:Region:111122223333:report/*"
        }
      }
    }));

    // 2. S3 バケットの作成
    const inspectorExportBucket = new s3.Bucket(this, 'InspectorExportBucket', {
      // ポリシーに合わせた固定バケット名を指定
      bucketName: 'amzn-s3-demo-bucket',
      encryption: s3.BucketEncryption.KMS,
      encryptionKey: inspectorExportKey,
      versioned: true,
      removalPolicy: cdk.RemovalPolicy.DESTROY, // ※開発用。実運用時は注意
      autoDeleteObjects: true,                // ※開発用。実運用時は注意
    });

    // S3 バケットポリシーを追加
    inspectorExportBucket.addToResourcePolicy(new iam.PolicyStatement({
      sid: "allow-inspector",
      effect: iam.Effect.ALLOW,
      principals: [new iam.ServicePrincipal('inspector2.amazonaws.com')],
      actions: [
        "s3:PutObject",
        "s3:PutObjectAcl",
        "s3:AbortMultipartUpload"
      ],
      // バケット内すべてのオブジェクトに対して許可するため、arnForObjects("*") を使用
      resources: [inspectorExportBucket.arnForObjects("*")],
      conditions: {
        "StringEquals": {
          "aws:SourceAccount": "111122223333"
        },
        "ArnLike": {
          "aws:SourceArn": "arn:aws:inspector2:Region:111122223333:report/*"
        }
      }
    }));

    // 3. CloudFormation 出力（後続の Inspector 設定等で利用可能にするため）
    new cdk.CfnOutput(this, 'InspectorExportBucketName', {
      value: inspectorExportBucket.bucketName,
      description: 'The S3 bucket used for Amazon Inspector export reports',
    });

    new cdk.CfnOutput(this, 'InspectorExportKeyArn', {
      value: inspectorExportKey.keyArn,
      description: 'The ARN of the KMS key used for encrypting the Amazon Inspector export reports',
    });
  }
}

const app = new cdk.App();
new InspectorExportStack(app, 'InspectorExportStack');
