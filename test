import psycopg2
import time

# データベース接続情報を設定します。ローカルのフォワーディングポート15432を使用。
conn = psycopg2.connect(
    dbname="development",
    user="your_username",
    password="your_password",
    host="localhost",  # ポートフォワーディングを使用するため、ホストはlocalhostに設定
    port=15432         # ローカルのフォワーディングポート
)
cursor = conn.cursor()

# ログファイル設定
log_file_path = "log.txt"

# 初期化（test1テーブルにid=1のデータが存在することを確認し、なければ挿入）
cursor.execute("SELECT EXISTS(SELECT 1 FROM test1 WHERE id=1)")
if not cursor.fetchone()[0]:
    cursor.execute("INSERT INTO test1 (number) VALUES (0)")
    conn.commit()

# カウントアップの初期値
number = 1

try:
    with open(log_file_path, 'a') as log_file:
        while True:
            try:
                # 更新処理
                update_start_time = time.time()
                cursor.execute("UPDATE test1 SET number = %s WHERE id = 1", (number,))
                conn.commit()
                update_time = (time.time() - update_start_time) * 1000  # ミリ秒単位で計測

                # 読み取り処理
                read_start_time = time.time()
                cursor.execute("SELECT number FROM test1 WHERE id = 1")
                read_number = cursor.fetchone()[0]
                read_time = (time.time() - read_start_time) * 1000  # ミリ秒単位で計測

                # コンソールとログファイルへの出力
                update_msg = f"[更新に費やした時間] write:{read_number}"
                read_msg = f"[表示に費やした時間] read:{read_number}"
                print(update_msg)
                print(read_msg)
                log_file.write(update_msg + '\n')
                log_file.write(read_msg + '\n')

                # カウントアップ
                number += 1

            except Exception as e:
                error_msg = "[更新に費やした時間] write:NG\n[表示に費やした時間] read:NG"
                print(error_msg)
                log_file.write(error_msg + '\n')

            # 100ms待機
            time.sleep(0.1)

finally:
    cursor.close()
    conn.close()
