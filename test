name: Manage Rollback Branches

on:
  pull_request:
    types:
      - closed

jobs:
  manage-rollback:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.merged }}
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Setup environment
        run: |
          MERGE_TIME=$(date +'%Y%m%d%H%M%S')
          echo "MERGE_TIME=${MERGE_TIME}" >> $GITHUB_ENV
          echo "BASE_BRANCH=${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
          echo "ROLLBACK_BRANCH=${{ github.event.pull_request.base.ref }}Rollback${MERGE_TIME}" >> $GITHUB_ENV
          echo "Environment variables set:"
          echo "MERGE_TIME=${MERGE_TIME}"
          echo "BASE_BRANCH=${{ github.event.pull_request.base.ref }}"
          echo "ROLLBACK_BRANCH=${{ github.event.pull_request.base.ref }}Rollback${MERGE_TIME}"

      - name: Create and push rollback branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching base branch state before merge..."
          git fetch origin +refs/pull/${{ github.event.pull_request.number }}/merge:refs/remotes/origin/PR_MERGE
          git checkout origin/PR_MERGE^2
          git checkout -b $ROLLBACK_BRANCH
          git push origin $ROLLBACK_BRANCH
          echo "Pushed rollback branch $ROLLBACK_BRANCH"

      - name: Prune old rollback branches
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Pruning old rollback branches..."
          ROLLBACK_PREFIX="${BASE_BRANCH}Rollback"
          git fetch --prune origin
          ROLLBACK_BRANCHES=$(git for-each-ref --format='%(refname:short)' refs/remotes/origin | grep ${ROLLBACK_PREFIX} | sort -r)
          COUNTER=0
          for BRANCH in $ROLLBACK_BRANCHES; do
            if [[ $COUNTER -ge 5 ]]; then
              git push origin --delete "${BRANCH#origin/}"
            fi
            COUNTER=$((COUNTER+1))
          done
          echo "Pruned old rollback branches"
