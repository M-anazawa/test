import { v4 as uuidv4 } from 'uuid';

const rdsSnapshotProject = new codebuild.Project(this, `${context.codeBuildProjectWebappName}-rds-snapshot`, {
  projectName: `${context.codeBuildProjectWebappName}-rds-snapshot`,
  environment: {
    buildImage: codebuild.LinuxBuildImage.STANDARD_5_0,
    computeType: codebuild.ComputeType.SMALL,
  },
  environmentVariables: {
    RDS_INSTANCE_IDENTIFIER: {
      value: context.rdsInstanceId,
    },
    SNAPSHOT_IDENTIFIER: {
      value: `snapshot-${context.rdsInstanceId.replace(/[^a-zA-Z0-9-]/g, '')}-${uuidv4()}-${Date.now()}`
    },
  },
  buildSpec: codebuild.BuildSpec.fromObject({
    version: "0.2",
    phases: {
      pre_build: {
        commands: [
          "echo Creating RDS snapshot..."
        ],
      },
      build: {
        commands: [
          "aws rds create-db-snapshot --db-instance-identifier $RDS_INSTANCE_IDENTIFIER --db-snapshot-identifier $SNAPSHOT_IDENTIFIER"
        ],
      },
    },
  }),
});
