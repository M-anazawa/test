import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as sns from 'aws-cdk-lib/aws-sns';
import * as sns_subscriptions from 'aws-cdk-lib/aws-sns-subscriptions';
import * as events from 'aws-cdk-lib/aws-events';
import * as targets from 'aws-cdk-lib/aws-events-targets';

export interface HealthSlackStackProps extends cdk.StackProps {
  region: string;
}

export class HealthSlackStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props: HealthSlackStackProps) {
    super(scope, id, props);

    // コンテキストからSlackチャネルのメールアドレスを取得
    const slackEmail = this.node.tryGetContext('slackEmail');

    // SNSトピックの作成
    const healthNotificationTopic = new sns.Topic(this, 'HealthNotificationTopic', {
      displayName: 'AWS Health Notifications Topic'
    });

    // SNSトピックにSlackのメールエンドポイントを設定
    healthNotificationTopic.addSubscription(new sns_subscriptions.EmailSubscription(slackEmail));

    // EventBridgeルールの作成
    const eventPattern = {
      source: ['aws.health'],
      detailType: ['AWS Health Event', 'AWS Health Global Event'],
      detail: {
        eventTypeCategory: ['issue', 'accountNotification', 'investigation', 'scheduledChange'],
        eventScopeCode: ['ACCOUNT_SPECIFIC', 'PUBLIC']
      }
    };

    if (props.region === 'us-east-1') {
      // 米国東部（バージニア北部）のグローバルイベント用EventBridgeルール
      new events.Rule(this, 'VirginiaGlobalHealthRule', {
        ruleName: 'VirginiaGlobalHealthRule',
        eventPattern: {
          ...eventPattern,
          detail: {
            ...eventPattern.detail,
            service: ['IAM', 'Route53', 'AWS Health Dashboard']
          }
        },
        targets: [new targets.SnsTopic(healthNotificationTopic)]
      });
    } else if (props.region === 'ap-northeast-1') {
      // 東京リージョンのリージョン固有イベント用EventBridgeルール
      new events.Rule(this, 'TokyoRegionalHealthRule', {
        ruleName: 'TokyoRegionalHealthRule',
        eventPattern,
        targets: [new targets.SnsTopic(healthNotificationTopic)]
      });
    }
  }
}


#!/usr/bin/env node
import * as cdk from 'aws-cdk-lib';
import { HealthSlackStack } from '../lib/health-slack-stack';

const app = new cdk.App();

new HealthSlackStack(app, 'TokyoHealthSlackStack', {
  env: { region: 'ap-northeast-1' }, // 東京リージョン
  region: 'ap-northeast-1'
});

new HealthSlackStack(app, 'VirginiaHealthSlackStack', {
  env: { region: 'us-east-1' }, // 米国東部（バージニア北部）リージョン
  region: 'us-east-1'
});
