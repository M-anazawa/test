例: 約9 KBのJSONデータを含むファイル（large-body.json）を作成します。(JavaScript/TypeScriptで書かれており、aを9000回繰り返した文字列を生成します。)

{
  "largeData": "a".repeat(9000)
}

POSTリクエストを送信します。
curl -X POST https://your-domain/test/123/bbb/resource \
  -H "Content-Type: application/json" \
  -d @large-body.json


検査サイズを16 KBに設定する例
const webAcl = new wafv2.CfnWebACL(this, 'MyWebACL', {
  defaultAction: { allow: {} },
  scope: 'REGIONAL',
  visibilityConfig: {
    cloudWatchMetricsEnabled: true,
    sampledRequestsEnabled: true,
    metricName: 'MyWebACLMetric'
  },
  rules: [
    {
      priority: 1,
      name: 'AWSManagedRulesCommonRuleSet',
      overrideAction: { none: {} },
      visibilityConfig: {
        sampledRequestsEnabled: true,
        cloudWatchMetricsEnabled: true,
        metricName: 'AWSManagedRulesCommonRuleSetMetric'
      },
      statement: {
        managedRuleGroupStatement: {
          vendorName: 'AWS',
          name: 'AWSManagedRulesCommonRuleSet',
        },
      },
    },
  ],
  bodyParsingConfiguration: {
    inspectionLimitInBytes: 16384 // 16 KBに設定
  }
});




このリクエストがAWS WAFによってブロックされた理由は、リクエストボディのサイズが制限を超えていたためです。具体的には、AWS WAFのマネージドルールセット「AWSManagedRulesCommonRuleSet」のSizeRestrictions_BODYルールによってブロックされています。

1. ブロックの理由の詳細
terminatingRuleId: "AWSManagedRulesCommonRuleSet"

AWSのマネージドルールセット「AWSManagedRulesCommonRuleSet」に含まれるルールに基づいてリクエストが評価されました。
ruleId: "SizeRestrictions_BODY"

このルールは、リクエストボディのサイズを検査し、設定されたサイズ制限を超えた場合にリクエストをブロックします。
requestBodySize: 196599

リクエストボディのサイズは196,599バイト（約192KB）であり、AWS WAFのルールで許容される最大サイズ（通常は8KB）を大幅に超えています。
oversizeFields: ["REQUEST_BODY"]

ここに記載されているフィールド（REQUEST_BODY）がサイズ制限を超えたことを示しています。

2. SizeRestrictions_BODYルールについて
役割:

このルールは、大きすぎるリクエストボディをブロックします。不正なリクエストは通常、極端に大きなボディサイズを含むことが多く、これを防ぐためのルールです。
適用範囲:

リクエストボディ（POSTリクエストなど）に適用されます。
理由:

大きなリクエストボディは、以下のような攻撃やリスクの兆候と見なされます：
DoS攻撃: 過剰に大きなデータを送信することで、サーバーのリソースを枯渇させる攻撃。
バッファオーバーフロー: 大量のデータを使った脆弱性攻撃の試み。
不正なデータ挿入: 大きなペイロードに不正なデータや攻撃コードを埋め込む手法。

3. リクエストの詳細
リクエストボディサイズ: 196,599バイト

このリクエストボディは、AWS WAFのデフォルトの制限である8KB（8192バイト）を大幅に超えています。
Content-Length: "196599"

ヘッダーからもリクエストボディが約192KBであることが確認できます。
リクエスト先URI: "/qsh/provider/v1/notices"

このエンドポイントに対して、大きなリクエストボディが送信されています。

4. 対応方法
正当なリクエストの場合:

ルールの除外:

特定のルール（SizeRestrictions_BODY）を無効化することで、このリクエストがブロックされないように設定できます。
AWS WAFのコンソールまたはCDKコードで、SizeRestrictions_BODYルールをexcludedRulesとして指定します。
excludedRules: [
  {
    name: 'SizeRestrictions_BODY',
  },
],
ボディサイズの制限を調整:

AWS WAFのルールでは、8KB以上のリクエストボディを検査することはできません。必要に応じてリクエストボディを縮小するか、検査の必要性を再評価する必要があります。
不正なリクエストの場合:

大きなリクエストボディは攻撃の兆候である可能性が高いため、このままブロックを維持します。

5. 結論
このリクエストは、リクエストボディがAWS WAFの許容サイズ（8KB）を超過したため、SizeRestrictions_BODYルールによってブロックされました。このルールは、極端に大きなリクエストをブロックすることで、リソース消費攻撃や不正リクエストからサーバーを保護します。

対応方法: 正当なリクエストであればルールを無効化するか、リクエストボディのサイズを縮小するなどの調整が必要です。

