name: Manage S3 index.html

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Select the action to perform'
        required: true
        type: choice
        options:
          - 'Replace with maintenance'
          - 'Restore original'

jobs:
  manage-index:
    runs-on: ubuntu-latest

    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-1

    - name: Checkout maintenance branch
      if: ${{ github.event.inputs.action == 'Replace with maintenance' }}
      uses: actions/checkout@v2
      with:
        ref: maintenance

    - name: Backup current index.html
      if: ${{ github.event.inputs.action == 'Replace with maintenance' }}
      run: aws s3 mv s3://${{ secrets.S3_BUCKET_NAME }}/index.html s3://${{ secrets.S3_BUCKET_NAME }}/original-index.html

    - name: Upload new index.html
      if: ${{ github.event.inputs.action == 'Replace with maintenance' }}
      run: aws s3 cp maint/index.html s3://${{ secrets.S3_BUCKET_NAME }}/index.html

    - name: Restore original index.html
      if: ${{ github.event.inputs.action == 'Restore original' }}
      run: |
        aws s3 mv s3://${{ secrets.S3_BUCKET_NAME }}/original-index.html s3://${{ secrets.S3_BUCKET_NAME }}/index.html
